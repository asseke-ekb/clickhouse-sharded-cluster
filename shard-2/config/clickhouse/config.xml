<clickhouse>
    <!-- ==================== Network Settings ==================== -->
    <listen_host>0.0.0.0</listen_host>
    <http_port>8123</http_port>
    <tcp_port>9000</tcp_port>
    <interserver_http_port>9009</interserver_http_port>

    <!-- Prometheus metrics endpoint -->
    <prometheus>
        <endpoint>/metrics</endpoint>
        <port>9363</port>
        <metrics>true</metrics>
        <events>true</events>
        <asynchronous_metrics>true</asynchronous_metrics>
    </prometheus>

    <!-- ==================== ZooKeeper Configuration ==================== -->
    <zookeeper>
        <node>
            <host>zookeeper-1</host>
            <port>2181</port>
        </node>
        <node>
            <host>zookeeper-2</host>
            <port>2181</port>
        </node>
        <node>
            <host>zookeeper-3</host>
            <port>2181</port>
        </node>
        <session_timeout_ms>30000</session_timeout_ms>
        <operation_timeout_ms>10000</operation_timeout_ms>
    </zookeeper>

    <!-- ==================== Macros for Sharding ==================== -->
    <macros>
        <shard>02</shard>
        <cluster>dwh_sharded_cluster</cluster>
    </macros>

    <!-- ==================== Remote Servers (Cluster) ==================== -->
    <remote_servers>
        <dwh_sharded_cluster>
            <!-- Shard 1 -->
            <shard>
                <internal_replication>false</internal_replication>
                <replica>
                    <host>clickhouse-shard-01</host>
                    <port>9000</port>
                </replica>
            </shard>
            <!-- Shard 2 -->
            <shard>
                <internal_replication>false</internal_replication>
                <replica>
                    <host>clickhouse-shard-02</host>
                    <port>9000</port>
                </replica>
            </shard>
            <!-- Shard 3 -->
            <shard>
                <internal_replication>false</internal_replication>
                <replica>
                    <host>clickhouse-shard-03</host>
                    <port>9000</port>
                </replica>
            </shard>
        </dwh_sharded_cluster>
    </remote_servers>

    <!-- ==================== Memory Settings ==================== -->
    <max_server_memory_usage_to_ram_ratio>0.9</max_server_memory_usage_to_ram_ratio>
    <max_concurrent_queries>100</max_concurrent_queries>
    <max_connections>1024</max_connections>

    <!-- Cache settings optimized for queries -->
    <mark_cache_size>5368709120</mark_cache_size>
    <uncompressed_cache_size>10737418240</uncompressed_cache_size>

    <!-- ==================== MergeTree Settings ==================== -->
    <merge_tree>
        <max_bytes_to_merge_at_max_space_in_pool>161061273600</max_bytes_to_merge_at_max_space_in_pool>
        <max_replicated_merges_in_queue>32</max_replicated_merges_in_queue>
        <number_of_free_entries_in_pool_to_execute_mutation>20</number_of_free_entries_in_pool_to_execute_mutation>
        <max_bytes_to_merge_at_min_space_in_pool>1048576</max_bytes_to_merge_at_min_space_in_pool>
    </merge_tree>

    <!-- ==================== Background Operations ==================== -->
    <background_pool_size>32</background_pool_size>
    <background_schedule_pool_size>128</background_schedule_pool_size>
    <background_message_broker_schedule_pool_size>16</background_message_broker_schedule_pool_size>
    <background_merges_mutations_concurrency_ratio>4</background_merges_mutations_concurrency_ratio>

    <!-- ==================== Compression ==================== -->
    <compression>
        <case>
            <method>zstd</method>
            <level>3</level>
        </case>
    </compression>

    <!-- ==================== Logging ==================== -->
    <logger>
        <level>information</level>
        <log>/var/log/clickhouse-server/clickhouse-server.log</log>
        <errorlog>/var/log/clickhouse-server/clickhouse-server.err.log</errorlog>
        <size>1000M</size>
        <count>10</count>
    </logger>

    <!-- ==================== Query Log Settings ==================== -->
    <query_log>
        <database>system</database>
        <table>query_log</table>
        <partition_by>toYYYYMM(event_date)</partition_by>
        <ttl>event_date + INTERVAL 30 DAY</ttl>
        <flush_interval_milliseconds>7500</flush_interval_milliseconds>
    </query_log>

    <!-- ==================== Distributed DDL Settings ==================== -->
    <distributed_ddl>
        <path>/clickhouse/task_queue/ddl</path>
    </distributed_ddl>

    <!-- ==================== Timezone ==================== -->
    <timezone>UTC</timezone>

    <!-- ==================== Path Settings ==================== -->
    <path>/var/lib/clickhouse/</path>
    <tmp_path>/var/lib/clickhouse/tmp/</tmp_path>
    <user_files_path>/var/lib/clickhouse/user_files/</user_files_path>
    <format_schema_path>/var/lib/clickhouse/format_schemas/</format_schema_path>

</clickhouse>
