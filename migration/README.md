# –ú–∏–≥—Ä–∞—Ü–∏—è Medical Services –≤ ClickHouse —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä

–ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü `medical_services` –∏ `medical_service_registers` –∏–∑ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–≥–æ ClickHouse (192.168.9.15) –≤ —à–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∞—Å—Ç–µ—Ä –∏–∑ 4 —É–∑–ª–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º ReplacingMergeTree.

## üìÅ –§–∞–π–ª—ã –≤ —ç—Ç–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏

### 1. [MIGRATION-GUIDE.md](MIGRATION-GUIDE.md) ‚≠ê **–ù–ê–ß–ù–ò–¢–ï –û–¢–°–Æ–î–ê**
–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –ø–æ—à–∞–≥–æ–≤—ã–º–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏:
- –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞
- –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ö–µ–º—ã
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Airflow
- –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏
- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
- Troubleshooting

### 2. [medical-services-schema.sql](medical-services-schema.sql)
SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä–µ:
- `outpatient.medical_services_local` (ReplacingMergeTree)
- `outpatient.medical_service_registers_local` (ReplacingMergeTree)
- Distributed —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∑–∞–ø–∏—Å–∏
- VIEW —Å FINAL –¥–ª—è —á—Ç–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –≤–µ—Ä—Å–∏–π

### 3. [airflow_migration_dag.py](airflow_migration_dag.py)
Airflow DAG –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö:
- –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞—Ç—á–∞–º–∏ –ø–æ –º–µ—Å—è—Ü–∞–º
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `remote()` –¥–ª—è —á—Ç–µ–Ω–∏—è –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–∞
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ OPTIMIZE TABLE
- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### 4. [test-queries.sql](test-queries.sql)
–ù–∞–±–æ—Ä SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ —à–∞—Ä–¥–∞–º
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–æ/–ø–æ—Å–ª–µ
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ JOIN –∑–∞–ø—Ä–æ—Å–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ –∏ –ø–∞—Ä—Ç–∏—Ü–∏–π
- –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

### 5. [KNIME-MIGRATION-GUIDE.md](KNIME-MIGRATION-GUIDE.md) üÜï **KNIME WORKFLOW**
–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ KNIME Analytics Platform:
- –í–∏–∑—É–∞–ª—å–Ω—ã–π workflow –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Database Connectors
- –ë–∞—Ç—á–∏–Ω–≥ —á–µ—Ä–µ–∑ Loop —É–∑–ª—ã
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### 6. [KNIME-QUICK-START.md](KNIME-QUICK-START.md) üÜï **–ë–´–°–¢–†–´–ô –°–¢–ê–†–¢ KNIME**
–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π KNIME workflow –∑–∞ 30 –º–∏–Ω—É—Ç:
- –ü—Ä–æ—Å—Ç–µ–π—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –±–µ–∑ Loop (–¥–ª—è —Ç–µ—Å—Ç–∞)
- Copy-paste –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–∑–ª–æ–≤
- –®–∞–≥ –∑–∞ —à–∞–≥–æ–º –æ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ß–µ—Ä–µ–∑ KNIME (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) üÜï

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –õ–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Airflow

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ KNIME Analytics Platform
2. –°–∫–∞—á–∞–π—Ç–µ ClickHouse JDBC –¥—Ä–∞–π–≤–µ—Ä
3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º: [KNIME-QUICK-START.md](KNIME-QUICK-START.md)

---

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ß–µ—Ä–µ–∑ Airflow

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å —Å—Ö–µ–º—É –Ω–∞ –∫–ª–∞—Å—Ç–µ—Ä–µ

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –ª—é–±–æ–º—É —É–∑–ª—É –∫–ª–∞—Å—Ç–µ—Ä–∞
docker exec -it clickhouse-shard-01 clickhouse-client --user admin --password admin123

# –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç
clickhouse-client --multiquery < migration/medical-services-schema.sql
```

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Airflow

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pip install apache-airflow-providers-common-sql clickhouse-connect

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å DAG —Ñ–∞–π–ª
cp migration/airflow_migration_dag.py $AIRFLOW_HOME/dags/

# –°–æ–∑–¥–∞—Ç—å Airflow Connections (—á–µ—Ä–µ–∑ UI):
# - clickhouse_source: 192.168.9.15:9000
# - clickhouse_cluster: –≤–∞—à –∫–ª–∞—Å—Ç–µ—Ä
```

### –®–∞–≥ 3: –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –í Airflow UI:
# - –ù–∞–π—Ç–∏ DAG: medical_services_migration_to_cluster
# - –ù–∞–∂–∞—Ç—å "Trigger DAG"
# - –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ Graph View
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

```sql
-- –°—Ä–∞–≤–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
SELECT 'source' as location, count() as rows
FROM remote('192.168.9.15:9000', 'outpatient.medical_services', 'default', '')

UNION ALL

SELECT 'target_final' as location, count() as rows
FROM outpatient.medical_services_actual;

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —à–∞—Ä–¥–∞–º
SELECT _shard_num, count() as rows, round(count() * 100.0 / (SELECT count() FROM outpatient.medical_services), 2) as percent
FROM outpatient.medical_services
GROUP BY _shard_num;
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ—à–µ–Ω–∏—è

### 1. ReplacingMergeTree –≤–º–µ—Å—Ç–æ MergeTree
**–ü—Ä–æ–±–ª–µ–º–∞:** –•—Ä–∞–Ω—è—Ç—Å—è –≤—Å–µ –≤–µ—Ä—Å–∏–∏, –≤—ã–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –º–µ–¥–ª–µ–Ω–Ω–∞—è
```sql
-- –ë—ã–ª–æ (–º–µ–¥–ª–µ–Ω–Ω–æ):
SELECT * FROM medical_services
WHERE (id, version) IN (SELECT id, MAX(version) FROM medical_services GROUP BY id)

-- –°—Ç–∞–ª–æ (–±—ã—Å—Ç—Ä–æ):
SELECT * FROM medical_services_actual  -- –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ FINAL
```

### 2. Co-located JOIN
**–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- `medical_services`: –ø–æ `id`
- `medical_service_registers`: –ø–æ `medical_service_id`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –Ω–∞ –æ–¥–Ω–æ–º —à–∞—Ä–¥–µ, JOIN –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–±—ã—Å—Ç—Ä–æ)

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
```sql
ENGINE = ReplacingMergeTree(version)
ORDER BY (id, service_date, version)
```
- –ü—Ä–∏ —Å–ª–∏—è–Ω–∏–∏ –ø–∞—Ä—Ç–∏—Ü–∏–π ClickHouse –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –≤–µ—Ä—Å–∏–∏
- –û—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å—å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `version`

### 4. –®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ 4 —É–∑–ª–∞–º
- –†–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (~25% –Ω–∞ –∫–∞–∂–¥–æ–º)
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  –ò—Å—Ö–æ–¥–Ω–∏–∫: 192.168.9.15 (–º–æ–Ω–æ–ª–∏—Ç)                  ‚îÇ
‚îÇ  ‚îú‚îÄ medical_services: 50M –∑–∞–ø–∏—Å–µ–π (–≤—Å–µ –≤–µ—Ä—Å–∏–∏)    ‚îÇ
‚îÇ  ‚îî‚îÄ medical_service_registers: 100M –∑–∞–ø–∏—Å–µ–π       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
                      ‚îÇ –ú–∏–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ Airflow
                      ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ZooKeeper (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è ON CLUSTER)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ            ‚îÇ            ‚îÇ            ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇShard-1 ‚îÇ  ‚îÇShard-2 ‚îÇ  ‚îÇShard-3 ‚îÇ  ‚îÇShard-4 ‚îÇ
    ‚îÇ  25%   ‚îÇ  ‚îÇ  25%   ‚îÇ  ‚îÇ  25%   ‚îÇ  ‚îÇ  25%   ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

–®–∞—Ä–¥–∏—Ä–æ–≤–∞–Ω–∏–µ:
‚îú‚îÄ medical_services: sipHash64(id)
‚îî‚îÄ medical_service_registers: sipHash64(medical_service_id)
```

## üìà –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤:
- **–ü—Ä–æ—Å—Ç—ã–µ SELECT:** 2-3x –±—ã—Å—Ç—Ä–µ–µ (–¥–∞–Ω–Ω—ã–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã)
- **JOIN –∑–∞–ø—Ä–æ—Å—ã:** 3-5x –±—ã—Å—Ç—Ä–µ–µ (co-located)
- **–ê–≥—Ä–µ–≥–∞—Ü–∏–∏:** 4x –±—ã—Å—Ç—Ä–µ–µ (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞)
- **–í—ã–±–æ—Ä–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏:** 10-20x –±—ã—Å—Ç—Ä–µ–µ (FINAL –≤–º–µ—Å—Ç–æ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞)

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤:
- **–ü–∞–º—è—Ç—å:** –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 40-60% (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è)
- **–î–∏—Å–∫:** –≠–∫–æ–Ω–æ–º–∏—è 30-50% –ø–æ—Å–ª–µ OPTIMIZE (—É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π)
- **CPU:** –†–∞–≤–Ω–æ–º–µ—Ä–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ 4 —É–∑–ª–∞

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. ORDER BY –∫–ª—é—á –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å version
```sql
-- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ (version –≤ –∫–æ–Ω—Ü–µ):
ORDER BY (id, service_date, version)

-- ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ (version –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç):
ORDER BY (id, service_date)
```

### 2. FINAL –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
```sql
-- –î–ª—è –æ—Ç—á–µ—Ç–æ–≤ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:
SELECT * FROM medical_services_actual  -- —Å FINAL

-- –î–ª—è –±—ã—Å—Ç—Ä—ã—Ö OLTP –∑–∞–ø—Ä–æ—Å–æ–≤ (–¥–æ–ø—É—Å—Ç–∏–º—ã –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥—É–±–ª–∏–∫–∞—Ç—ã):
SELECT * FROM medical_services  -- –±–µ–∑ FINAL
```

### 3. OPTIMIZE TABLE –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏
```sql
-- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏):
OPTIMIZE TABLE medical_services_local ON CLUSTER 'dwh_sharded_cluster' FINAL;
```

### 4. –ë–∞—Ç—á–∏–Ω–≥ –ø—Ä–∏ –º–∏–≥—Ä–∞—Ü–∏–∏
- –ú–∏–≥—Ä–∞—Ü–∏—è –∏–¥–µ—Ç –±–∞—Ç—á–∞–º–∏ –ø–æ –º–µ—Å—è—Ü–∞–º (–Ω–µ –≤—Å—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–∑—É)
- –†–∞–∑–º–µ—Ä –±–∞—Ç—á–∞: 500k –∑–∞–ø–∏—Å–µ–π
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –º–∏–≥—Ä–∏—Ä—É—é—Ç—Å—è –æ–±–µ —Ç–∞–±–ª–∏—Ü—ã

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–∏–≥—Ä–∞—Ü–∏–∏

### –í Airflow UI:
- Graph View - –≤–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
- Task Logs - –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –∫–∞–∂–¥–æ–≥–æ –±–∞—Ç—á–∞
- Duration - –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### –í ClickHouse:
```sql
-- –¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
SELECT _shard_num, count() as rows_migrated
FROM outpatient.medical_services
GROUP BY _shard_num;

-- –ê–∫—Ç–∏–≤–Ω—ã–µ –≤—Å—Ç–∞–≤–∫–∏
SELECT query, elapsed, formatReadableSize(memory_usage) as memory
FROM system.processes
WHERE query LIKE '%INSERT INTO outpatient%';
```

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [ClickHouse ReplacingMergeTree](https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/replacingmergetree)
- [ClickHouse Distributed Tables](https://clickhouse.com/docs/en/engines/table-engines/special/distributed)
- [ClickHouse Sharding](https://clickhouse.com/docs/en/architecture/horizontal-scaling)
- [Apache Airflow](https://airflow.apache.org/docs/)

## ü§ù –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º –º–∏–≥—Ä–∞—Ü–∏–∏:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [MIGRATION-GUIDE.md](MIGRATION-GUIDE.md) - —Ä–∞–∑–¥–µ–ª Troubleshooting
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Airflow
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ ClickHouse: `docker logs clickhouse-shard-01`

---

**–ê–≤—Ç–æ—Ä:** Claude Code
**–î–∞—Ç–∞:** 2025-01-12
**–õ–∏—Ü–µ–Ω–∑–∏—è:** MIT
